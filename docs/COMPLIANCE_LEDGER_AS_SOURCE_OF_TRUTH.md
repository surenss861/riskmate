# Compliance Ledger Contract v1.0

**Status:** ‚úÖ **FROZEN - Production Contract**  
**Version:** 1.0.0  
**Effective Date:** January 2025  
**Last Updated:** January 10, 2026

## üö´ **DO NOT MODIFY WITHOUT PM APPROVAL**

This contract defines the Compliance Ledger as RiskMate's immutable audit trail. Changes require PM approval and must maintain backward compatibility with existing exports and integrations.

---

## Overview

The Compliance Ledger is RiskMate's single source of truth for all meaningful actions that affect safety, compliance, insurance defensibility, payments, or disputes. Every page and feature routes into the Ledger, making it the central hub for audit, compliance, and governance evidence.

---

## Core Principle: "Ledger is Law"

**Every meaningful action must generate an audit event. No exceptions.**

If an action can affect:
- Safety
- Compliance
- Insurance defensibility
- Payments
- Disputes

‚Üí It writes to the Ledger.

**Enforcement Mechanism:**
- All mutations go through a server-side `auditWrite()` wrapper
- No UI-only logging. No "best effort."
- If audit write fails, mutation fails (except truly low-value events)
- Append-only ledger: corrections are new events, not edits

---

## Canonical Event Schema (v1.0 - Non-Negotiable)

**Minimum fields every event MUST have:**

### Required Fields
- `event_id` - Unique identifier (UUID)
- `event_type` - Canonical event name (e.g., `job.created`, `auth.role_violation`)
- `occurred_at` - ISO 8601 timestamp (when the action happened)
- `org_id` - Organization identifier
- `actor_id` - User who performed the action (nullable for system events)
- `actor_role` - Role of the actor (e.g., `owner`, `admin`, `safety_lead`)
- `target_type` - Type of resource affected (`job`, `site`, `user`, `organization`)
- `target_id` - Identifier of the affected resource
- `severity` - Event severity (`critical`, `material`, `info`)
- `outcome` - Action outcome (`blocked`, `allowed`, `success`, `failure`)
- `summary` - Human-readable event description (required for all events)
- `context` - JSON metadata (structured data, filters, related IDs)
- `integrity` - Hash chain pointer (hash of previous event + current event data)

### Optional Fields (Auto-Enriched)
- `actor_name`, `actor_email` - Actor details (auto-populated)
- `target_name` - Human-readable target name (e.g., job title, site name)
- `category` - Computed category (`governance`, `operations`, `access`)
- `review_reason` - Why this event requires review (if applicable)
- `assigned_to` - Review owner role (if applicable)
- `due_date` - Review deadline (if applicable)
- `exposure` - Insurance/regulatory/owner impact (if applicable)

**Schema Stability:** This schema is frozen. New fields must be added as optional context metadata, not required fields.

---

## Severity Taxonomy (v1.0 - Locked)

**Three-tier severity system (brutally simple):**

### Critical
- Immediate risk to safety or operations
- Potential claim exposure (insurance/legal liability)
- Requires immediate human intervention
- Examples: `auth.role_violation` (executive attempting mutation), `incident.created` (high severity)

### Material
- Audit/contract exposure but not emergency
- Regulatory compliance risk
- Requires review within defined SLA (e.g., 48 hours)
- Examples: `job.flagged_for_review`, `signoff.rejected`, `policy.violation`

### Info
- Everything else
- Normal operations, informational events
- No immediate action required
- Examples: `job.created`, `document.uploaded`, `login.success`

**Enforcement:** Every `event_type` must have a severity mapping. Unknown severities default to `info`.

---

## Exports Contract (v1.0)

### CSV Export
- **Purpose:** Human-readable operations export
- **Format:** Tabular with header block
- **Includes:** Export ID, timestamp, generated by, organization, view preset, filters, time range, event count
- **Use case:** Operations teams, daily/weekly reviews, spreadsheet analysis

### API Payload (JSON) Export
- **Purpose:** Systems/integrations export (SIEM, GRC tools, automation)
- **Location:** Advanced / Integrations menu (kebab menu)
- **Format:** Structured bundle with metadata and integrity info
- **Includes:** Full event schema, hash chain, verification data
- **Use case:** Integrations, webhooks, data warehouse, Splunk/Datadog, verification endpoints

### Proof Pack (ZIP)
- **Purpose:** Board-grade audit artifact for insurers/clients
- **Format:** ZIP bundle containing PDF + evidence manifest JSON + attachments
- **Includes:** Ledger PDF, controls CSV, attestations CSV, manifest with hashes
- **Use case:** Insurance requests, client deliverables, regulatory submissions

### Executive Brief (PDF)
- **Purpose:** Board-grade executive decision memo
- **Format:** 2-page PDF with integrity block and verification
- **Includes:** Risk posture, key metrics, recommended actions, verification endpoint
- **Use case:** Executive reviews, board presentations, C-suite decision artifacts

### Ledger PDF Export
- **Status:** **v2.0 (Future)**
- **Current:** CSV + API payload + Proof Pack covers all export needs
- **Rationale:** Executive Brief + Proof Pack serve board-grade PDF needs

**Export Contract:** All exports must include export ID, timestamp, generated by, filters applied, event count, and hash chain verification status.

## Canonical Actions (Always Logged)

### Job Lifecycle
- `job.created` - New job record created
- `job.updated` - Job details modified
- `job.archived` - Job moved to archived status
- `job.deleted` - Job permanently removed (strict eligibility)
- `job.risk_score_changed` - Risk score updated due to factor changes

### Review & Governance
- `job.flagged_for_review` - Job marked for safety lead review
- `job.unflagged` - Review flag removed
- `job.review_assigned` - Review responsibility assigned
- `job.review_note_added` - Review comment recorded
- `job.review_resolved` - Review completed with outcome

### Risk & Mitigation
- `mitigation.completed` - Mitigation action completed
- `mitigation.updated` - Mitigation checklist item modified

### Evidence & Documentation
- `document.uploaded` - Document/photo/permit attached
- `photo.uploaded` - Evidence photo added
- `proof_pack.{type}_generated` - Proof pack exported (insurance/audit/incident/compliance)

### Sign-offs & Approvals
- `job.signoff_created` - Digital sign-off captured
- `job.signoff_signed` - Sign-off completed
- `job.signoff_rejected` - Sign-off rejected

### Governance Enforcement
- `auth.role_violation` - Action blocked due to insufficient permissions
- `account.organization_updated` - Organization settings changed

### Access & Security
- `team.invite_sent` - User invitation sent
- `team.invite_accepted` - User joined organization
- `team.member_removed` - Access revoked
- `team.role_changed` - User role modified
- `security.login` - User authenticated
- `security.password_changed` - Password updated
- `security.session_revoked` - Session terminated

### Billing & Subscriptions
- `billing.subscription_created` - Subscription activated
- `billing.subscription_updated` - Subscription modified
- `billing.plan_changed` - Plan tier changed
- `billing.subscription_canceled` - Subscription canceled

### Exports & Sharing
- `audit.export` - Compliance Ledger exported (CSV/JSON/PDF)

## Review Queue

The Review Queue is a saved view that answers: **"What needs attention right now?"**

### Rules
- Jobs flagged for review (`review_flag = true`)
- Critical or material severity events (last 30 days)
- Blocked governance actions (policy violations)
- Missing required sign-offs (per job requirements)
- Open incidents (flagged + high risk)

### Implementation
- Saved view preset: `review-queue`
- Shows across all categories (not tab-filtered)
- Default sorting: Most recent first
- One-click export: CSV/JSON

## Two-Layer Architecture

### Layer 1: Review Queue (Derived View)
- **Purpose:** "What needs attention right now?"
- **Content:** Filtered subset of Ledger events requiring action
- **Access:** All roles (visibility varies by role)

### Layer 2: Ledger History (Complete Evidence)
- **Purpose:** "Everything that happened, filterable and exportable"
- **Content:** Complete audit trail with all events
- **Access:** Role-based (Owner/Admin/Safety Lead/Executive)

## Navigation Pattern: Everything Routes to Ledger

### Job Detail Page
- **"View in Compliance Ledger"** button ‚Üí `/operations/audit?job_id={id}`
- Opens Ledger filtered to that job's events

### Job Roster
- **"Ledger"** link in Actions column ‚Üí `/operations/audit?job_id={id}`
- Quick access to job's complete action history

### Job Packet View
- **"View complete action history in Compliance Ledger"** link ‚Üí `/operations/audit?job_id={id}`
- Links to full timeline beyond packet summary

### Executive Snapshot
- **"View complete evidence in Compliance Ledger"** link ‚Üí `/operations/audit?view=review-queue&severity=material`
- Opens Review Queue filtered to material/critical events

### Sites Page
- **"View site compliance"** ‚Üí `/operations/audit?site_id={id}` (future)

## Event Enrichment

All events are automatically enriched server-side with:
- **Actor:** Name, role, email
- **Target:** Job title, risk score, flagged status, site name
- **Context:** Review reason, assigned role, due date (for flagged events)
- **Exposure:** Insurance/regulatory/owner impact (for violations)

## Review Context Display

For flagged/review events, the UI shows:
- **Reason:** Why the job was flagged
- **Assigned To:** Review owner role (e.g., "safety_lead")
- **Due Date:** Review deadline (if set)

This makes the Ledger the review timeline, not just a log.

## Export Headers (Required in All Exports)

**Every export MUST include this header block:**

```json
{
  "export_id": "EXP-<timestamp>-<random>",
  "generated_at": "2026-01-10T12:00:00.000Z",
  "generated_by": {
    "user_id": "uuid",
    "name": "John Doe",
    "email": "john@example.com",
    "role": "admin"
  },
  "organization": {
    "id": "org-uuid",
    "name": "Organization Name"
  },
  "preset_id": "review-queue" | "insurance-ready" | "governance-enforcement" | "incident-review" | "access-review" | null,
  "filters": {
    "time_range": "90d",
    "severity": "material",
    "category": "governance",
    "job_id": null,
    "site_id": null,
    "actor_id": null,
    "outcome": null
  },
  "sort": "most_recent_first",
  "event_count": 42,
  "hash_chain_verification": "‚úÖ PASS" | "‚ö†Ô∏è WARNING" | "‚ùå FAIL",
  "schema_version": "1.0"
}
```

**Hash Chain Verification:**
- ‚úÖ PASS: All events have valid integrity hashes
- ‚ö†Ô∏è WARNING: Some events missing hashes (legacy data)
- ‚ùå FAIL: Hash chain broken (potential tampering)

## Industry-Specific Language

The Ledger adapts terminology based on organization's vertical:
- **Facilities:** Work Order, Facility, Compliance Packet
- **Fire & Life Safety:** Inspection, Location, Inspection Report
- **Heavy Civil:** Work Package, Project/Corridor, Owner/Regulator Packet
- **Commercial Contractors:** Job, Site, Client Compliance Packet
- **Residential Trades:** Job, Location, Insurance Packet

## Saved Views (Compliance Modes) - Stable Presets

**Preset IDs are frozen. Filter snapshots are deterministic.**

### 1. Review Queue (Default)
- **Preset ID:** `review-queue`
- **Purpose:** What needs attention now
- **Filters:**
  - Jobs flagged for review (`review_flag = true`)
  - Critical or material severity events (last 30 days)
  - Blocked governance actions (policy violations)
  - Missing required sign-offs (per job requirements)
  - Open incidents (flagged + high risk)
- **Category:** All categories (not tab-filtered)
- **Sort:** Most recent first
- **Actions:** Assign, Resolve

### 2. Insurance-Ready
- **Preset ID:** `insurance-ready`
- **Purpose:** Ready for insurer/client request
- **Filters:**
  - Completed jobs only (`status = 'completed'`)
  - Jobs with proof packs generated
  - Jobs with required sign-offs completed
  - Time range: Last 30 days (configurable)
- **Category:** Operations
- **Sort:** Most recent first
- **Actions:** Generate Proof Pack

### 3. Governance Enforcement
- **Preset ID:** `governance-enforcement`
- **Purpose:** Prove role enforcement and separation of duties
- **Filters:**
  - Blocked actions (`outcome = 'blocked'`)
  - Policy violations (`severity = 'critical' OR 'material'`)
  - Role violations (`event_type LIKE 'auth.%'`)
  - Category: Governance only
- **Sort:** Most recent first
- **Actions:** Export Enforcement Report

### 4. Incident Review
- **Preset ID:** `incident-review`
- **Purpose:** Complete incident trail
- **Filters:**
  - Flagged jobs + escalations
  - High-severity events (`severity = 'critical'`)
  - Mitigation actions
  - Corrective actions created
- **Category:** Operations
- **Sort:** Most recent first
- **Actions:** Create Corrective Action, Close Incident

### 5. Access Review
- **Preset ID:** `access-review`
- **Purpose:** Security audit trail
- **Filters:**
  - Role changes (`event_type LIKE 'team.role_changed'`)
  - Login events (`event_type LIKE 'security.login'`)
  - Access revocations (`event_type LIKE 'team.member_removed'`)
  - Category: Access only
- **Sort:** Most recent first
- **Actions:** Revoke Access, Flag Suspicious

**Preset Stability:** Preset IDs are immutable. Filter snapshots must be deterministic and reproducible. Exports must embed: `preset_id`, `filters`, `sort`, `time_range`, `severity`, `event_count`.

## Evidence Drawer

Clicking any evidence link opens a side panel showing:
- **Related Resource:** Job/site info with quick links
- **Timeline:** All events related to that resource
- **One-Click Export:** "Export Evidence Slice" for that specific job/resource

## Technical Implementation

### Backend Enforcement
- **`auditWrite()` wrapper:** All mutations must go through server-side audit logger
- **No UI-only logging:** Frontend cannot directly write to Ledger
- **Fail-fast:** If audit write fails, mutation fails (except low-value events)
- **Hash chain:** Each event includes hash of previous event + current event data
- **Auto-enrichment:** Actor details, target names, categories computed server-side
- **Comprehensive indexes:** Fast filtering by category, severity, time range, target
- **Schema validation:** All events validated against canonical schema before write

### Frontend Display
- **Saved view cards:** Visual cards (not dropdowns) for compliance modes
- **Industry language mapping:** Terminology adapts to organization vertical
- **Review context inline:** Review reasons, assignments, deadlines shown inline
- **Evidence drawer:** Side panel showing related resources + timeline
- **Event details drawer:** Expandable event cards with full metadata
- **Export with headers:** All exports include required header block

### Immutability Posture
- **Append-only ledger:** Events are never edited or deleted
- **Corrections are new events:** If an event needs correction, create a new event with `event_type = '{original_type}.corrected'`
- **Hash chain integrity:** Broken hash chain indicates potential tampering
- **Verification endpoint:** `/api/verify/{export_id}` returns hash chain status

## Migration Path

All existing features now:
1. Log events to Ledger (if not already)
2. Link to Ledger from detail pages
3. Use Ledger as the source of truth for "what happened"

No new pages needed. Everything becomes a filtered view or shortcut into the Ledger.

## Success Metrics (v1.0 Contract)

- ‚úÖ **Zero "Unknown" events** - All events mapped and human-readable (enforced by schema)
- ‚úÖ **Complete coverage** - Every meaningful action generates an event (enforced by `auditWrite()`)
- ‚úÖ **Fast filtering** - Sub-100ms queries even at scale (enforced by indexes)
- ‚úÖ **Export-ready** - All exports include headers, IDs, verification (enforced by export contract)
- ‚úÖ **Buyer-trustworthy** - Feels like compliance product, not dev tool (enforced by UX patterns)

---

## Contract Versioning

**This is v1.0 Compliance Ledger Contract. Treat changes like API changes:**

- **Breaking changes** require major version bump (v2.0)
- **Schema additions** (new optional fields) are minor version (v1.1)
- **Filter additions** (new preset) are minor version (v1.1)
- **Enhancements** (UX improvements, new exports) are minor version (v1.1)

**Changes require:**
1. PM approval
2. Backward compatibility analysis
3. Migration path for existing exports
4. Updated export headers with schema version
5. Golden test updates (if applicable)

---

## Evidence Slices (Future Concept - v2.0)

**"Evidence Slice" export** = one job/site/user timeline zipped

- Purpose: Mid-incident export for specific resource
- Format: ZIP with timeline PDF + related events JSON + attachments
- Use case: "Show me everything about Job-123" during incident response
- Status: **v2.0 enhancement** (not in v1.0 contract)

---

## Terminology Notes

- **"API Payload"** (not "JSON export") - Clarifies systems/integrations use case
- **"Evidence Manifest"** (alternative name for API payload) - More compliance-native terminology (future consideration)
- **"Proof Pack"** - Insurance-ready bundle (ZIP with PDF + manifests)
- **"Executive Brief"** - Board-grade 2-page PDF with verification

---

**This contract is frozen. Changes require PM approval and version bump.**

