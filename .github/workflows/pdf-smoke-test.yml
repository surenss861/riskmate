name: PDF Smoke Tests

on:
  pull_request:
    paths:
      - 'app/reports/packet/**'
      - 'components/report/**'
      - 'lib/utils/packets/**'
      - 'lib/design-system/pdfTheme.ts'
      - 'scripts/pdf-smoke-test.ts'
  push:
    branches:
      - main
    paths:
      - 'app/reports/packet/**'
      - 'components/report/**'
      - 'lib/utils/packets/**'
      - 'lib/design-system/pdfTheme.ts'
      - 'scripts/pdf-smoke-test.ts'
  workflow_dispatch:
    inputs:
      print_url:
        description: 'Print URL to test (optional, uses secrets if not provided)'
        required: false

jobs:
  pdf-smoke-test:
    name: PDF Generation Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Chromium (with system deps)
        run: npx playwright install --with-deps chromium

      - name: Run smoke test (manual URL input)
        if: github.event.inputs.print_url != ''
        env:
          PRINT_URL: ${{ github.event.inputs.print_url }}
          PRINT_TOKEN: ${{ secrets.PDF_TEST_TOKEN }}
        run: |
          echo "üß™ Testing provided URL..."
          pnpm run test:pdf-smoke "$PRINT_URL" "$PRINT_TOKEN"

      - name: Check if test URLs are configured
        if: github.event.inputs.print_url == ''
        id: check_urls
        run: |
          missing=""
          for k in PDF_TEST_URL_AUDIT PDF_TEST_URL_INCIDENT PDF_TEST_URL_COMPLIANCE PDF_TEST_URL_INSURANCE PDF_TEST_TOKEN; do
            if [ -z "${!k}" ]; then
              missing="$missing $k"
            fi
          done
          
          # Check secrets (GitHub Actions syntax)
          if [ -z "${{ secrets.PDF_TEST_URL_AUDIT }}" ] || \
             [ -z "${{ secrets.PDF_TEST_URL_INCIDENT }}" ] || \
             [ -z "${{ secrets.PDF_TEST_URL_COMPLIANCE }}" ] || \
             [ -z "${{ secrets.PDF_TEST_URL_INSURANCE }}" ] || \
             [ -z "${{ secrets.PDF_TEST_TOKEN }}" ]; then
            echo "skip_tests=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  PDF test URLs not configured - skipping tests"
            echo "Configure secrets: PDF_TEST_URL_AUDIT, PDF_TEST_URL_INCIDENT, PDF_TEST_URL_COMPLIANCE, PDF_TEST_URL_INSURANCE, PDF_TEST_TOKEN"
          else
            echo "skip_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Run smoke test - Audit Packet
        if: github.event.inputs.print_url == '' && steps.check_urls.outputs.skip_tests == 'false'
        continue-on-error: true
        env:
          PRINT_URL: ${{ secrets.PDF_TEST_URL_AUDIT }}
          PRINT_TOKEN: ${{ secrets.PDF_TEST_TOKEN }}
          PACKET_LABEL: AUDIT
        run: |
          echo "üß™ Testing Audit Packet..."
          pnpm run test:pdf-smoke "$PRINT_URL" "$PRINT_TOKEN" || echo "‚ùå Audit packet test failed" > audit-failure.txt

      - name: Run smoke test - Incident Packet
        if: github.event.inputs.print_url == '' && steps.check_urls.outputs.skip_tests == 'false'
        continue-on-error: true
        env:
          PRINT_URL: ${{ secrets.PDF_TEST_URL_INCIDENT }}
          PRINT_TOKEN: ${{ secrets.PDF_TEST_TOKEN }}
          PACKET_LABEL: INCIDENT
        run: |
          echo "üß™ Testing Incident Packet..."
          pnpm run test:pdf-smoke "$PRINT_URL" "$PRINT_TOKEN" || echo "‚ùå Incident packet test failed" > incident-failure.txt

      - name: Run smoke test - Compliance Packet
        if: github.event.inputs.print_url == '' && steps.check_urls.outputs.skip_tests == 'false'
        continue-on-error: true
        env:
          PRINT_URL: ${{ secrets.PDF_TEST_URL_COMPLIANCE }}
          PRINT_TOKEN: ${{ secrets.PDF_TEST_TOKEN }}
          PACKET_LABEL: COMPLIANCE
        run: |
          echo "üß™ Testing Compliance Packet..."
          pnpm run test:pdf-smoke "$PRINT_URL" "$PRINT_TOKEN" || echo "‚ùå Compliance packet test failed" > compliance-failure.txt

      - name: Run smoke test - Insurance Packet
        if: github.event.inputs.print_url == '' && steps.check_urls.outputs.skip_tests == 'false'
        continue-on-error: true
        env:
          PRINT_URL: ${{ secrets.PDF_TEST_URL_INSURANCE }}
          PRINT_TOKEN: ${{ secrets.PDF_TEST_TOKEN }}
          PACKET_LABEL: INSURANCE
        run: |
          echo "üß™ Testing Insurance Packet..."
          pnpm run test:pdf-smoke "$PRINT_URL" "$PRINT_TOKEN" || echo "‚ùå Insurance packet test failed" > insurance-failure.txt

      - name: Check test results
        if: github.event.inputs.print_url == '' && steps.check_urls.outputs.skip_tests == 'false'
        run: |
          failures=$(find . -name "*-failure.txt" 2>/dev/null | wc -l)
          if [ "$failures" -gt 0 ]; then
            echo "‚ùå $failures packet type(s) failed smoke tests:"
            find . -name "*-failure.txt" -exec cat {} \;
            exit 1
          else
            echo "‚úÖ All packet types passed smoke tests!"
          fi

      - name: Upload test artifacts (screenshots)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pdf-smoke-test-screenshots
          path: |
            pdf-smoke-artifacts/**/*.png
            pdf-smoke-artifacts/**/*.jpg
          retention-days: 7
          if-no-files-found: ignore

      - name: Skip message
        if: github.event.inputs.print_url == '' && steps.check_urls.outputs.skip_tests == 'true'
        run: |
          echo "‚ÑπÔ∏è  PDF test URLs not configured in repository secrets"
          echo "To enable automated testing, add these secrets:"
          echo "  - PDF_TEST_URL_AUDIT"
          echo "  - PDF_TEST_URL_INCIDENT"
          echo "  - PDF_TEST_URL_COMPLIANCE"
          echo "  - PDF_TEST_URL_INSURANCE"
          echo "  - PDF_TEST_TOKEN"
          echo ""
          echo "You can still run tests manually:"
          echo "  npm run test:pdf-smoke <print-url> [token]"

