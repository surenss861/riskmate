name: PDF Smoke Tests

on:
  pull_request:
    paths:
      - 'app/reports/**'
      - 'components/report/**'
      - 'lib/utils/packets/**'
      - 'lib/design-system/pdfTheme.ts'
      - 'scripts/pdf-smoke-test.ts'
      - 'pdf-service/**'
  push:
    branches:
      - main
    paths:
      - 'app/reports/**'
      - 'components/report/**'
      - 'lib/utils/packets/**'
      - 'lib/design-system/pdfTheme.ts'
      - 'scripts/pdf-smoke-test.ts'
      - 'pdf-service/**'
  workflow_dispatch:
    inputs:
      print_url:
        description: 'Print URL to test (optional, uses secrets if not provided)'
        required: false

jobs:
  pdf-smoke-test:
    name: PDF Generation Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: pdf-smoke-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Chromium (with system deps)
        run: npx playwright install --with-deps chromium

      - name: Run smoke test (manual URL input)
        if: github.event.inputs.print_url != ''
        env:
          PRINT_URL: ${{ github.event.inputs.print_url }}
          PRINT_TOKEN: ${{ secrets.PDF_TEST_TOKEN }}
        run: |
          echo "üß™ Testing provided URL..."
          pnpm run test:pdf-smoke "$PRINT_URL" "$PRINT_TOKEN"

      - name: Check if test URLs are configured
        if: github.event.inputs.print_url == ''
        id: check_urls
        run: |
          # Check secrets (GitHub Actions syntax)
          if [ -z "${{ secrets.PDF_TEST_URL_AUDIT }}" ] || \
             [ -z "${{ secrets.PDF_TEST_URL_INCIDENT }}" ] || \
             [ -z "${{ secrets.PDF_TEST_URL_COMPLIANCE }}" ] || \
             [ -z "${{ secrets.PDF_TEST_URL_INSURANCE }}" ] || \
             [ -z "${{ secrets.PDF_TEST_TOKEN }}" ]; then
            echo "skip_tests=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  PDF test URLs not configured - skipping tests"
            echo "Configure secrets: PDF_TEST_URL_AUDIT, PDF_TEST_URL_INCIDENT, PDF_TEST_URL_COMPLIANCE, PDF_TEST_URL_INSURANCE, PDF_TEST_TOKEN"
          else
            echo "skip_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Run smoke test - ${{ matrix.packet.label }}
        if: github.event.inputs.print_url == '' && steps.check_urls.outputs.skip_tests == 'false'
        continue-on-error: true
        strategy:
          fail-fast: false
          matrix:
            packet:
              - label: AUDIT
              - label: INCIDENT
              - label: COMPLIANCE
              - label: INSURANCE
        env:
          PDF_TEST_URL_AUDIT: ${{ secrets.PDF_TEST_URL_AUDIT }}
          PDF_TEST_URL_INCIDENT: ${{ secrets.PDF_TEST_URL_INCIDENT }}
          PDF_TEST_URL_COMPLIANCE: ${{ secrets.PDF_TEST_URL_COMPLIANCE }}
          PDF_TEST_URL_INSURANCE: ${{ secrets.PDF_TEST_URL_INSURANCE }}
          PRINT_TOKEN: ${{ secrets.PDF_TEST_TOKEN }}
          PACKET_LABEL: ${{ matrix.packet.label }}
        run: |
          case "${{ matrix.packet.label }}" in
            AUDIT)
              PRINT_URL="$PDF_TEST_URL_AUDIT"
              ;;
            INCIDENT)
              PRINT_URL="$PDF_TEST_URL_INCIDENT"
              ;;
            COMPLIANCE)
              PRINT_URL="$PDF_TEST_URL_COMPLIANCE"
              ;;
            INSURANCE)
              PRINT_URL="$PDF_TEST_URL_INSURANCE"
              ;;
          esac
          echo "üß™ Testing ${{ matrix.packet.label }} Packet..."
          pnpm run test:pdf-smoke "$PRINT_URL" "$PRINT_TOKEN" || echo "‚ùå ${{ matrix.packet.label }} packet test failed" > ${{ matrix.packet.label }}-failure.txt

      - name: Check test results
        if: github.event.inputs.print_url == '' && steps.check_urls.outputs.skip_tests == 'false'
        run: |
          failures=$(find . -name "*-failure.txt" 2>/dev/null | wc -l)
          if [ "$failures" -gt 0 ]; then
            echo "‚ùå $failures packet type(s) failed smoke tests:"
            find . -name "*-failure.txt" -exec cat {} \;
            exit 1
          else
            echo "‚úÖ All packet types passed smoke tests!"
          fi

      - name: Upload test artifacts (screenshots)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pdf-smoke-test-screenshots-${{ matrix.packet.label || 'manual' }}
          path: |
            pdf-smoke-artifacts/**/*.png
            pdf-smoke-artifacts/**/*.jpg
          retention-days: 7
          if-no-files-found: ignore

      - name: Skip message
        if: github.event.inputs.print_url == '' && steps.check_urls.outputs.skip_tests == 'true'
        run: |
          echo "‚ÑπÔ∏è  PDF test URLs not configured in repository secrets"
          echo "To enable automated testing, add these secrets:"
          echo "  - PDF_TEST_URL_AUDIT"
          echo "  - PDF_TEST_URL_INCIDENT"
          echo "  - PDF_TEST_URL_COMPLIANCE"
          echo "  - PDF_TEST_URL_INSURANCE"
          echo "  - PDF_TEST_TOKEN"
          echo ""
          echo "Note: PDF_TEST_TOKEN should be long-lived for CI. If it expires, tests will fail."
          echo ""
          echo "You can still run tests manually:"
          echo "  npm run test:pdf-smoke <print-url> [token]"
