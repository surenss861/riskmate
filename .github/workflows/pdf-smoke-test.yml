name: PDF Smoke Tests

on:
  pull_request:
    paths:
      - 'app/reports/**'
      - 'components/report/**'
      - 'lib/utils/packets/**'
      - 'lib/design-system/pdfTheme.ts'
      - 'scripts/pdf-smoke-test.ts'
      - 'pdf-service/**'
  push:
    branches: [main]
    paths:
      - 'app/reports/**'
      - 'components/report/**'
      - 'lib/utils/packets/**'
      - 'lib/design-system/pdfTheme.ts'
      - 'scripts/pdf-smoke-test.ts'
      - 'pdf-service/**'
  workflow_dispatch:
    inputs:
      print_url:
        description: 'Print URL to test (optional, uses secrets if not provided)'
        required: false
        default: ''
      print_token:
        description: 'Print token for authentication (optional, uses secrets if not provided)'
        required: false
        default: ''

concurrency:
  group: pdf-smoke-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  pdf-smoke-test-manual:
    name: PDF Smoke Test - Manual
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.print_url != '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Verify pnpm
        run: pnpm -v

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Chromium (with system deps)
        run: npx playwright install --with-deps chromium

      - name: Generate CI print token
        id: generate_token_manual
        if: github.event.inputs.print_token == ''
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI_JOB_ID: 'ci-manual-test-job'
          CI_ORG_ID: 'ci-test-org'
          CI_RUN_ID: 'ci-manual-test-run'
          TOKEN_EXPIRY_DAYS: '7'
        run: |
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "‚ö†Ô∏è  SUPABASE_SERVICE_ROLE_KEY not set - skipping token generation"
            echo "   Will use PDF_TEST_TOKEN secret if available"
          else
            TOKEN=$(node scripts/generate-ci-print-token.ts 2>&1 | grep -A 1 "Generated CI print token" | tail -1 | tr -d '[:space:]')
            echo "PRINT_TOKEN=${TOKEN}" >> $GITHUB_ENV
            echo "‚úÖ Generated token for CI (valid 7 days)"
          fi

      - name: Run smoke test (manual URL)
        env:
          PRINT_URL: ${{ github.event.inputs.print_url }}
          PRINT_TOKEN: ${{ github.event.inputs.print_token || secrets.PDF_TEST_TOKEN || env.PRINT_TOKEN }}
          PACKET_LABEL: MANUAL
        run: |
          echo "üß™ Testing provided URL..."
          pnpm run test:pdf-smoke "$PRINT_URL" "$PRINT_TOKEN"

      - name: Upload artifacts (screenshots)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pdf-smoke-test-manual-${{ github.run_attempt }}
          path: |
            pdf-smoke-artifacts/**/*.png
            pdf-smoke-artifacts/**/*.jpg
          retention-days: 7
          if-no-files-found: ignore

  pdf-smoke-test:
    name: PDF Smoke Test - ${{ matrix.packet.label }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.print_url != '') }}

    strategy:
      fail-fast: false
      matrix:
        packet:
          - label: AUDIT
            url_secret: PDF_TEST_URL_AUDIT
          - label: INCIDENT
            url_secret: PDF_TEST_URL_INCIDENT
          - label: COMPLIANCE
            url_secret: PDF_TEST_URL_COMPLIANCE
          - label: INSURANCE
            url_secret: PDF_TEST_URL_INSURANCE

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Verify pnpm
        run: pnpm -v

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Chromium (with system deps)
        run: npx playwright install --with-deps chromium

      - name: Validate secrets configured
        id: secrets_check
        env:
          PRINT_TOKEN: ${{ secrets.PDF_TEST_TOKEN }}
          PDF_TEST_URL_AUDIT: ${{ secrets.PDF_TEST_URL_AUDIT }}
          PDF_TEST_URL_INCIDENT: ${{ secrets.PDF_TEST_URL_INCIDENT }}
          PDF_TEST_URL_COMPLIANCE: ${{ secrets.PDF_TEST_URL_COMPLIANCE }}
          PDF_TEST_URL_INSURANCE: ${{ secrets.PDF_TEST_URL_INSURANCE }}
        run: |
          missing=0
          missing_secrets=""
          # PDF_TEST_TOKEN is optional - we can generate it automatically
          # if [ -z "$PRINT_TOKEN" ]; then echo "Missing: PDF_TEST_TOKEN"; missing_secrets="$missing_secrets PDF_TEST_TOKEN"; missing=1; fi
          if [ -z "$PDF_TEST_URL_AUDIT" ]; then echo "Missing: PDF_TEST_URL_AUDIT"; missing_secrets="$missing_secrets PDF_TEST_URL_AUDIT"; missing=1; fi
          if [ -z "$PDF_TEST_URL_INCIDENT" ]; then echo "Missing: PDF_TEST_URL_INCIDENT"; missing_secrets="$missing_secrets PDF_TEST_URL_INCIDENT"; missing=1; fi
          if [ -z "$PDF_TEST_URL_COMPLIANCE" ]; then echo "Missing: PDF_TEST_URL_COMPLIANCE"; missing_secrets="$missing_secrets PDF_TEST_URL_COMPLIANCE"; missing=1; fi
          if [ -z "$PDF_TEST_URL_INSURANCE" ]; then echo "Missing: PDF_TEST_URL_INSURANCE"; missing_secrets="$missing_secrets PDF_TEST_URL_INSURANCE"; missing=1; fi
          
          if [ "$missing" -eq 1 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "missing_secrets=$missing_secrets" >> $GITHUB_OUTPUT
            
            # On main branch, fail if secrets are missing (enforcement)
            # This applies to both push and workflow_dispatch events
            # On PRs, skip gracefully (bootstrap mode)
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              echo "‚ùå FAILING: Secrets are required on main branch to prevent regressions"
              echo "Missing secrets:$missing_secrets"
              echo ""
              echo "Add these secrets to enable PDF smoke tests:"
              echo "  - PDF_TEST_URL_AUDIT"
              echo "  - PDF_TEST_URL_INCIDENT"
              echo "  - PDF_TEST_URL_COMPLIANCE"
              echo "  - PDF_TEST_URL_INSURANCE"
              echo ""
              echo "Note: PDF_TEST_TOKEN is optional - tokens are auto-generated if missing"
              echo "      (requires SUPABASE_SERVICE_ROLE_KEY secret to be set)"
              exit 1
            fi
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip message (missing secrets - PR only)
        if: steps.secrets_check.outputs.skip == 'true' && github.event_name == 'pull_request'
        run: |
          echo "‚ö†Ô∏è  PDF test secrets not configured. Skipping on PR."
          echo "Missing secrets:${{ steps.secrets_check.outputs.missing_secrets }}"
          echo ""
          echo "Add these secrets to enable PDF smoke tests:"
          echo "  - PDF_TEST_URL_AUDIT"
          echo "  - PDF_TEST_URL_INCIDENT"
          echo "  - PDF_TEST_URL_COMPLIANCE"
          echo "  - PDF_TEST_URL_INSURANCE"
          echo ""
          echo "Note: PDF_TEST_TOKEN is optional - tokens are auto-generated if missing"
          echo "      (requires SUPABASE_SERVICE_ROLE_KEY secret to be set)"

      - name: Generate CI print token
        id: generate_token_matrix
        if: steps.secrets_check.outputs.skip == 'false'
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI_JOB_ID: 'ci-${{ matrix.packet.label }}-test-job'
          CI_ORG_ID: 'ci-test-org'
          CI_RUN_ID: 'ci-${{ matrix.packet.label }}-test-run'
          TOKEN_EXPIRY_DAYS: '7'
        run: |
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "‚ö†Ô∏è  SUPABASE_SERVICE_ROLE_KEY not set - cannot generate token"
            echo "   Set PDF_TEST_TOKEN secret or SUPABASE_SERVICE_ROLE_KEY to enable token generation"
            exit 1
          fi
          TOKEN=$(node scripts/generate-ci-print-token.ts 2>&1 | grep -A 1 "Generated CI print token" | tail -1 | tr -d '[:space:]')
          echo "PRINT_TOKEN=${TOKEN}" >> $GITHUB_ENV
          echo "‚úÖ Generated token for CI (valid 7 days)"

      - name: Health check (preflight URL validation)
        if: steps.secrets_check.outputs.skip == 'false'
        env:
          PDF_TEST_URL_AUDIT: ${{ secrets.PDF_TEST_URL_AUDIT }}
          PDF_TEST_URL_INCIDENT: ${{ secrets.PDF_TEST_URL_INCIDENT }}
          PDF_TEST_URL_COMPLIANCE: ${{ secrets.PDF_TEST_URL_COMPLIANCE }}
          PDF_TEST_URL_INSURANCE: ${{ secrets.PDF_TEST_URL_INSURANCE }}
          PRINT_TOKEN: ${{ secrets.PDF_TEST_TOKEN || env.PRINT_TOKEN }}
        run: |
          case "${{ matrix.packet.url_secret }}" in
            PDF_TEST_URL_AUDIT) PRINT_URL="$PDF_TEST_URL_AUDIT" ;;
            PDF_TEST_URL_INCIDENT) PRINT_URL="$PDF_TEST_URL_INCIDENT" ;;
            PDF_TEST_URL_COMPLIANCE) PRINT_URL="$PDF_TEST_URL_COMPLIANCE" ;;
            PDF_TEST_URL_INSURANCE) PRINT_URL="$PDF_TEST_URL_INSURANCE" ;;
          esac
          
          # Use generated token if secret token not available
          FINAL_TOKEN="${PRINT_TOKEN:-${GITHUB_ENV_PRINT_TOKEN}}"
          if [ -z "$FINAL_TOKEN" ]; then
            echo "‚ùå No token available (neither PDF_TEST_TOKEN secret nor generated token)"
            exit 1
          fi
          
          # Add token to URL if not present
          if [[ "$PRINT_URL" != *"token="* ]]; then
            if [[ "$PRINT_URL" == *"?"* ]]; then
              PRINT_URL="${PRINT_URL}&token=${FINAL_TOKEN}"
            else
              PRINT_URL="${PRINT_URL}?token=${FINAL_TOKEN}"
            fi
          fi
          
          echo "üîç Preflight check: ${{ matrix.packet.label }} Packet URL..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$PRINT_URL" || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ URL is accessible (HTTP 200)"
          elif [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
            echo "‚ö†Ô∏è  URL returned HTTP $HTTP_CODE (auth issue - token may be expired)"
            echo "‚ö†Ô∏è  Continuing anyway - Playwright will handle auth..."
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "‚ùå URL returned HTTP 404 (URL may be invalid or expired)"
            exit 1
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "‚ö†Ô∏è  Preflight check failed (timeout/network) - continuing anyway..."
          else
            echo "‚ö†Ô∏è  URL returned HTTP $HTTP_CODE - continuing with test..."
          fi

      - name: Run smoke test - ${{ matrix.packet.label }}
        if: steps.secrets_check.outputs.skip == 'false'
        env:
          PDF_TEST_URL_AUDIT: ${{ secrets.PDF_TEST_URL_AUDIT }}
          PDF_TEST_URL_INCIDENT: ${{ secrets.PDF_TEST_URL_INCIDENT }}
          PDF_TEST_URL_COMPLIANCE: ${{ secrets.PDF_TEST_URL_COMPLIANCE }}
          PDF_TEST_URL_INSURANCE: ${{ secrets.PDF_TEST_URL_INSURANCE }}
          PRINT_TOKEN: ${{ secrets.PDF_TEST_TOKEN || env.PRINT_TOKEN }}
        run: |
          case "${{ matrix.packet.url_secret }}" in
            PDF_TEST_URL_AUDIT) PRINT_URL="$PDF_TEST_URL_AUDIT" ;;
            PDF_TEST_URL_INCIDENT) PRINT_URL="$PDF_TEST_URL_INCIDENT" ;;
            PDF_TEST_URL_COMPLIANCE) PRINT_URL="$PDF_TEST_URL_COMPLIANCE" ;;
            PDF_TEST_URL_INSURANCE) PRINT_URL="$PDF_TEST_URL_INSURANCE" ;;
          esac
          
          if [ -z "$PRINT_TOKEN" ]; then
            echo "‚ùå No token available for testing"
            exit 1
          fi
          
          echo "üß™ Testing ${{ matrix.packet.label }} Packet..."
          pnpm run test:pdf-smoke "$PRINT_URL" "$PRINT_TOKEN"

      - name: Upload artifacts (screenshots)
        if: always() && steps.secrets_check.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: pdf-smoke-test-${{ matrix.packet.label }}-${{ github.run_attempt }}
          path: |
            pdf-smoke-artifacts/**/*.png
            pdf-smoke-artifacts/**/*.jpg
          retention-days: 7
          if-no-files-found: ignore
