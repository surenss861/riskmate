name: PDF Smoke Test

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: pdf-smoke-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  CI: true

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      can_run: ${{ steps.check.outputs.can_run }}
    steps:
      - id: check
        name: Check required secrets
        shell: bash
        env:
          PDF_TEST_TOKEN: ${{ secrets.PDF_TEST_TOKEN }}
          PDF_TEST_URL_AUDIT: ${{ secrets.PDF_TEST_URL_AUDIT }}
          PDF_TEST_URL_INCIDENT: ${{ secrets.PDF_TEST_URL_INCIDENT }}
          PDF_TEST_URL_COMPLIANCE: ${{ secrets.PDF_TEST_URL_COMPLIANCE }}
          PDF_TEST_URL_INSURANCE: ${{ secrets.PDF_TEST_URL_INSURANCE }}
        run: |
          missing=()
          for k in PDF_TEST_TOKEN PDF_TEST_URL_AUDIT PDF_TEST_URL_INCIDENT PDF_TEST_URL_COMPLIANCE PDF_TEST_URL_INSURANCE; do
            if [ -z "${!k}" ]; then missing+=("$k"); fi
          done

          if [ ${#missing[@]} -eq 0 ]; then
            echo "can_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Missing secrets: ${missing[*]}"
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_name }}" = "main" ]; then
            echo "::error::Missing required secrets on main push: ${missing[*]}"
            exit 1
          fi

          echo "can_run=false" >> "$GITHUB_OUTPUT"
          echo "Bootstrap mode: skipping PDF smoke tests on PR because secrets are missing."

  pdf-smoke:
    needs: preflight
    if: needs.preflight.outputs.can_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - packet: AUDIT
            url_secret: PDF_TEST_URL_AUDIT
          - packet: INCIDENT
            url_secret: PDF_TEST_URL_INCIDENT
          - packet: COMPLIANCE
            url_secret: PDF_TEST_URL_COMPLIANCE
          - packet: INSURANCE
            url_secret: PDF_TEST_URL_INSURANCE

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Verify pnpm on PATH
        run: |
          which pnpm
          pnpm -v
          node -v

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers + deps
        run: pnpm exec playwright install --with-deps chromium

      - name: Generate CI print token (if needed)
        id: generate_token
        env:
          PDF_TEST_TOKEN: ${{ secrets.PDF_TEST_TOKEN }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI_JOB_ID: 'ci-${{ matrix.packet }}-test-job'
          CI_ORG_ID: 'ci-test-org'
          CI_RUN_ID: 'ci-${{ matrix.packet }}-test-run'
          TOKEN_EXPIRY_DAYS: '7'
        run: |
          if [ -n "$PDF_TEST_TOKEN" ]; then
            echo "✅ Using PDF_TEST_TOKEN secret (skipping generation)"
            exit 0
          fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "::error::No token available: PDF_TEST_TOKEN not set and SUPABASE_SERVICE_ROLE_KEY not available"
            exit 1
          fi
          TOKEN=$(node scripts/generate-ci-print-token.ts 2>&1 | grep -A 1 "Generated CI print token" | tail -1 | tr -d '[:space:]')
          echo "::add-mask::$TOKEN"
          echo "PRINT_TOKEN=${TOKEN}" >> $GITHUB_ENV
          echo "✅ Generated token for CI (valid 7 days)"

      - name: Run PDF smoke test (${{ matrix.packet }})
        env:
          PDF_TEST_URL_AUDIT: ${{ secrets.PDF_TEST_URL_AUDIT }}
          PDF_TEST_URL_INCIDENT: ${{ secrets.PDF_TEST_URL_INCIDENT }}
          PDF_TEST_URL_COMPLIANCE: ${{ secrets.PDF_TEST_URL_COMPLIANCE }}
          PDF_TEST_URL_INSURANCE: ${{ secrets.PDF_TEST_URL_INSURANCE }}
          PDF_TEST_TOKEN: ${{ secrets.PDF_TEST_TOKEN }}
          PRINT_TOKEN: ${{ secrets.PDF_TEST_TOKEN || env.PRINT_TOKEN }}
        run: |
          # Get URL from secret based on matrix.packet
          case "${{ matrix.packet }}" in
            AUDIT) PDF_URL="$PDF_TEST_URL_AUDIT" ;;
            INCIDENT) PDF_URL="$PDF_TEST_URL_INCIDENT" ;;
            COMPLIANCE) PDF_URL="$PDF_TEST_URL_COMPLIANCE" ;;
            INSURANCE) PDF_URL="$PDF_TEST_URL_INSURANCE" ;;
            *) echo "::error::Unknown packet type: ${{ matrix.packet }}"; exit 1 ;;
          esac
          
          if [ -z "$PDF_URL" ]; then
            echo "::error::PDF_URL is empty for ${{ matrix.packet }}"
            exit 1
          fi
          if [ -z "$PRINT_TOKEN" ]; then
            echo "::error::No token available (neither PDF_TEST_TOKEN secret nor generated token)"
            exit 1
          fi
          pnpm run test:pdf-smoke "$PDF_URL" "$PRINT_TOKEN"

      - name: Upload screenshots/reports (${{ matrix.packet }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pdf-smoke-${{ matrix.packet }}-${{ github.run_attempt }}
          path: |
            pdf-smoke-artifacts/**
          if-no-files-found: warn
          retention-days: 14
